digraph ExitPriority {
      rankdir=TB;
      bgcolor="#0a0a0a";
      fontname="Arial";
      fontsize=14;

      node [fontname="Arial", fontsize=11, style=filled];
      edge [fontname="Arial", fontsize=10];

      // Title
      title [label="Exit Priority Decision Tree\n(Simplified Flow)",
             shape=box, fillcolor="#2c3e50", fontcolor=white, fontsize=16, style="filled,bold"];

      // Entry point
      start [label="Active Position\nMonitoring", shape=oval, fillcolor="#3498db", fontcolor=white, fontsize=12];

      // Priority 1: Profit Target
      check_profit [label="Priority 1:\nProfit Target Reached?", shape=diamond, fillcolor="#27ae60", fontcolor=white];
      profit_calc [label="current_cost ≤\ncredit × 90%", shape=box, fillcolor="#2ecc71", fontcolor=white];
      exit_profit [label="EXIT:\nProfit Take", shape=box, fillcolor="#27ae60", fontcolor=white, style="filled,bold"];

      // Priority 2: Trailing Stop
      check_trailing [label="Priority 2:\nTrailing Stop Active?", shape=diamond, fillcolor="#f39c12", fontcolor=white];
      trailing_calc [label="unrealized_pnl ≤\nmax_profit × 70%", shape=box, fillcolor="#f1c40f", fontcolor=white];
      exit_trailing [label="EXIT:\nTrailing Stop", shape=box, fillcolor="#f39c12", fontcolor=white, style="filled,bold"];

      // Priority 3: Stop Loss
      check_stop [label="Priority 3:\nStop Loss Hit?", shape=diamond, fillcolor="#e74c3c", fontcolor=white];
      stop_calc [label="current_cost ≥\ncredit × ATR_multiplier\n(1.0x - 2.5x)", shape=box, fillcolor="#c0392b", fontcolor=white];
      exit_stop [label="EXIT:\nStop Loss", shape=box, fillcolor="#e74c3c", fontcolor=white, style="filled,bold"];

      // Priority 4: BB Breakout
      check_bb [label="Priority 4:\nBB Breakout Detected?", shape=diamond, fillcolor="#9b59b6", fontcolor=white];
      bb_calc [label="bb_position > 95%\nOR\nbb_position < 5%", shape=box, fillcolor="#8e44ad", fontcolor=white];
      exit_bb [label="EXIT:\nBB Breakout", shape=box, fillcolor="#9b59b6", fontcolor=white, style="filled,bold"];

      // Priority 5: Expiration
      check_expiry [label="Priority 5:\nExpiration Date?", shape=diamond, fillcolor="#34495e", fontcolor=white];
      expiry_calc [label="DTE ≤ 0\n(days to expiration)", shape=box, fillcolor="#2c3e50", fontcolor=white];
      exit_expiry [label="EXIT:\nExpiration", shape=box, fillcolor="#34495e", fontcolor=white, style="filled,bold"];

      // Hold position
      hold [label="HOLD:\nContinue Monitoring", shape=box, fillcolor="#16a085", fontcolor=white, style="filled,bold"];

      // Flow connections
      title -> start;
      start -> check_profit;

      check_profit -> profit_calc [label="Check"];
      profit_calc -> exit_profit [label="YES\n(Lock profit)"];
      profit_calc -> check_trailing [label="NO"];

      check_trailing -> trailing_calc [label="Check"];
      trailing_calc -> exit_trailing [label="YES\n(Protect profit)"];
      trailing_calc -> check_stop [label="NO"];

      check_stop -> stop_calc [label="Check"];
      stop_calc -> exit_stop [label="YES\n(Cut loss)"];
      stop_calc -> check_bb [label="NO"];

      check_bb -> bb_calc [label="Check"];
      bb_calc -> exit_bb [label="YES\n(Volatility expansion)"];
      bb_calc -> check_expiry [label="NO"];

      check_expiry -> expiry_calc [label="Check"];
      expiry_calc -> exit_expiry [label="YES\n(Forced close)"];
      expiry_calc -> hold [label="NO"];

      // Loop back
      hold -> start [label="Next bar", style=dashed, color="#7f8c8d"];

      // Legend
      legend [label="Priority Order (Top to Bottom):\n\n✓ Profit Take = Highest priority (secure gains)\n✓ Trailing Stop = Second (protect unrealized profit)\n✓ Stop Loss = Third (limit downside)\n✓ BB Breakout = Fourth (regime change)\n✓ Expiration = Fifth (time-based)\n\nAll checks evaluated EVERY bar\nFirst match triggers exit immediately",
              shape=note, fillcolor="#ffffcc", fontsize=10];

      // Layout helpers
      {rank=same; exit_profit; exit_trailing; exit_stop; exit_bb; exit_expiry;}

      hold -> legend [style=invis];
  }
