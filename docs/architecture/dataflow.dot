 digraph IndicatorInteraction {
    bgcolor="#0a0a0a";
      rankdir=TB;
      node [shape=box, style=rounded, fontname="Arial"];
      edge [fontname="Arial", fontsize=10];

      // Define color scheme
      node [fillcolor=lightblue, style="rounded,filled"];

      // ============= DATA LAYER =============
      subgraph cluster_data {
          label="Data Layer";
          style=filled;
          color=lightgrey;

          csv1 [label="SPY_1.csv\n(1-minute OHLCV)", fillcolor=lightyellow];
          csv5 [label="SPY_5.csv\n(5-minute OHLCV)", fillcolor=lightyellow];
          csv15 [label="SPY_15.csv\n(15-minute OHLCV)", fillcolor=lightyellow];
      }

      // ============= INDICATOR CALCULATION =============
      subgraph cluster_indicators {
          label="Indicator Calculation Layer\n(sync_engine.py)";
          style=filled;
          color=lightcyan;

          calc [label="Calculate Indicators\n(pandas-ta)", fillcolor=lightgreen];

          // Momentum Indicators
          rsi [label="RSI (14)\nStochastic (14,3,3)", shape=ellipse, fillcolor=orange];

          // Trend Indicators
          adx [label="ADX (14)\nSMA (20, 50)\nSMA Distance", shape=ellipse, fillcolor=orange];

          // Volatility Indicators
          bbands [label="Bollinger Bands (20,2)\nBB Position\nBB Width\nATR (14)", shape=ellipse, fillcolor=orange];

          // Volume Indicators
          volume [label="Volume MA (20)\nVolume Ratio", shape=ellipse, fillcolor=orange];

          // MTF/Market Indicators
          mtf [label="MTF Consensus\n(1m, 5m, 15m)", shape=ellipse, fillcolor=orange];
          ivr_vix [label="IV Rank\nVIX", shape=ellipse, fillcolor=orange];
      }

      // ============= MEMBERSHIP FUNCTIONS =============
      subgraph cluster_membership {
          label="Membership Functions Layer\n(fuzzy_engine.py)";
          style=filled;
          color=lavender;

          mem_title [label="Convert to Fuzzy Scores [0.0, 1.0]", shape=plaintext, fillcolor=none];

          mu_rsi [label="μ_RSI\nNeutral zone:\n40-60 = 1.0", fillcolor=pink];
          mu_adx [label="μ_ADX\nWeak trend:\n<25 = 1.0", fillcolor=pink];
          mu_stoch [label="μ_Stoch\nNeutral:\n30-70 = 1.0", fillcolor=pink];
          mu_bbands [label="μ_BBands\nMiddle + squeeze:\n0.5 pos + <2% width", fillcolor=pink];
          mu_sma [label="μ_SMA\nNear equilibrium:\n<2% distance = 1.0", fillcolor=pink];
          mu_volume [label="μ_Volume\nHigh liquidity:\n>80% avg = 1.0", fillcolor=pink];
          mu_mtf [label="μ_MTF\nNeutral action:\n0.4-0.6 = 1.0", fillcolor=pink];
          mu_iv [label="μ_IV\nHigh rank:\n>60 = 1.0", fillcolor=pink];
          mu_regime [label="μ_VIX\nLow vol:\n<12 = 1.0", fillcolor=pink];
      }

      // ============= HARD GATES =============
      subgraph cluster_gates {
          label="Hard Gate Filters\n(backtest_engine.py entry logic)";
          style=filled;
          color=mistyrose;

          gate_warmup [label="Warmup Gate\nBars > 60?", shape=diamond, fillcolor=yellow];
          gate_ivr [label="IVR Gate\n>= 30.0?", shape=diamond, fillcolor=yellow];
          gate_vix [label="VIX Gate\n<= 25.0?", shape=diamond, fillcolor=yellow];
          gate_rsi [label="RSI Gate\nμ >= 0.3?", shape=diamond, fillcolor=yellow];
          gate_adx [label="ADX Gate\nμ >= 0.3?", shape=diamond, fillcolor=yellow];
          gate_stoch [label="Stoch Gate\nμ >= 0.3?", shape=diamond, fillcolor=yellow];
          gate_bbands [label="BBands Gate\nμ >= 0.3?", shape=diamond, fillcolor=yellow];
          gate_volume [label="Volume Gate\nμ >= 0.3?", shape=diamond, fillcolor=yellow];
          gate_sma [label="SMA Gate\nμ >= 0.3?", shape=diamond, fillcolor=yellow];
          gate_mtf [label="MTF Gate\n0.4 <= μ <= 0.6?", shape=diamond, fillcolor=yellow];

          reject [label="REJECT ENTRY", fillcolor=red, fontcolor=white];
      }

      // ============= FUZZY WEIGHTING =============
      subgraph cluster_fuzzy {
          label="Fuzzy Confidence Calculation";
          style=filled;
          color=lightgreen;

          weights [label="Fuzzy Weights\nMTF: 25%\nIV: 18%\nVIX: 15%\nRSI: 10%\nADX: 10%\nBBands: 8%\nStoch: 7%\nVolume: 4%\nSMA: 3%", fillcolor=lightcyan];

          confidence [label="Fuzzy Confidence (Ft)\nFt = Σ(weight × μ)", fillcolor=lightgreen, shape=box];

          vol_penalty [label="Volatility Penalty\nσ* = (VIX - 12) / 18", fillcolor=lightcoral];

          scaling [label="Scaling Factor\ng = Ft × (1 - σ*)", fillcolor=lightgreen];
      }

      // ============= POSITION SIZING =============
      subgraph cluster_sizing {
          label="Position Sizing";
          style=filled;
          color=honeydew;

          base_qty [label="Base Quantity\nq0 = floor((2% × equity) / max_loss)", fillcolor=wheat];
          final_qty [label="Final Quantity\nq = floor(q0 × g)", fillcolor=lightgreen];

          execute [label="EXECUTE TRADE\nEnter Iron Condor", fillcolor=green, fontcolor=white, style="rounded,filled"];
      }

      // ============= EXIT LAYER =============
      subgraph cluster_exit {
          label="Exit Decision Layer";
          style=filled;
          color=lightyellow;

          atr_stop [label="ATR Dynamic Stop\nMultiplier: 1.0-2.5×", fillcolor=orange];
          trailing [label="Trailing Stop\nActivate at 50%\nTrail at 70%", fillcolor=orange];
          bb_exit [label="BB Breakout\nPosition > 95%", fillcolor=orange];
          profit_target [label="Profit Target\n90% of credit", fillcolor=lightgreen];
          stop_loss [label="Stop Loss\n120% or ATR×", fillcolor=red, fontcolor=white];
          expiration [label="Expiration\nDTE <= 0", fillcolor=grey];

          exit_decision [label="Exit Priority:\n1. Profit\n2. Trailing\n3. Stop\n4. BB Breakout\n5. Expiration", shape=box, fillcolor=yellow];

          close_trade [label="CLOSE TRADE", fillcolor=red, fontcolor=white, style="rounded,filled"];
      }

      // ============= DATA FLOW EDGES =============

      // Data -> Indicators
      csv1 -> calc;
      csv5 -> calc;
      csv15 -> calc;

      calc -> rsi;
      calc -> adx;
      calc -> bbands;
      calc -> volume;
      calc -> mtf;
      calc -> ivr_vix;

      // Indicators -> Memberships
      rsi -> mu_rsi;
      rsi -> mu_stoch;
      adx -> mu_adx;
      adx -> mu_sma;
      bbands -> mu_bbands;
      volume -> mu_volume;
      mtf -> mu_mtf;
      ivr_vix -> mu_iv;
      ivr_vix -> mu_regime;

      // Memberships -> Gates
      mu_rsi -> gate_rsi;
      mu_adx -> gate_adx;
      mu_stoch -> gate_stoch;
      mu_bbands -> gate_bbands;
      mu_sma -> gate_sma;
      mu_volume -> gate_volume;
      mu_mtf -> gate_mtf;
      mu_iv -> gate_ivr;
      mu_regime -> gate_vix;

      gate_warmup -> gate_ivr [label="PASS"];
      gate_ivr -> gate_vix [label="PASS"];
      gate_vix -> gate_rsi [label="PASS"];
      gate_rsi -> gate_adx [label="PASS"];
      gate_adx -> gate_stoch [label="PASS"];
      gate_stoch -> gate_bbands [label="PASS"];
      gate_bbands -> gate_volume [label="PASS"];
      gate_volume -> gate_sma [label="PASS"];
      gate_sma -> gate_mtf [label="PASS"];

      gate_warmup -> reject [label="FAIL", color=red];
      gate_ivr -> reject [label="FAIL", color=red];
      gate_vix -> reject [label="FAIL", color=red];
      gate_rsi -> reject [label="FAIL", color=red];
      gate_adx -> reject [label="FAIL", color=red];
      gate_stoch -> reject [label="FAIL", color=red];
      gate_bbands -> reject [label="FAIL", color=red];
      gate_volume -> reject [label="FAIL", color=red];
      gate_sma -> reject [label="FAIL", color=red];
      gate_mtf -> reject [label="FAIL", color=red];

      // Gates -> Fuzzy Weighting
      gate_mtf -> weights [label="ALL PASS"];

      mu_rsi -> confidence;
      mu_adx -> confidence;
      mu_stoch -> confidence;
      mu_bbands -> confidence;
      mu_sma -> confidence;
      mu_volume -> confidence;
      mu_mtf -> confidence;
      mu_iv -> confidence;
      mu_regime -> confidence;

      weights -> confidence;

      mu_regime -> vol_penalty;

      confidence -> scaling;
      vol_penalty -> scaling;

      // Sizing
      scaling -> base_qty;
      base_qty -> final_qty;
      final_qty -> execute;

      // Exit flow
      execute -> atr_stop;
      execute -> trailing;
      execute -> bb_exit;
      execute -> profit_target;
      execute -> stop_loss;
      execute -> expiration;

      atr_stop -> exit_decision;
      trailing -> exit_decision;
      bb_exit -> exit_decision;
      profit_target -> exit_decision;
      stop_loss -> exit_decision;
      expiration -> exit_decision;

      exit_decision -> close_trade;

      // Legend
      subgraph cluster_legend {
          label="Legend";
          style=filled;
          color=white;

          leg1 [label="Yellow Box = Data Source", fillcolor=lightyellow, shape=box];
          leg2 [label="Orange Circle = Indicator", fillcolor=orange, shape=ellipse];
          leg3 [label="Pink Box = Membership μ", fillcolor=pink, shape=box];
          leg4 [label="Yellow Diamond = Gate", fillcolor=yellow, shape=diamond];
          leg5 [label="Green Box = Approved Action", fillcolor=green, fontcolor=white, shape=box];
          leg6 [label="Red Box = Rejected/Exit", fillcolor=red, fontcolor=white, shape=box];
      }
  }
