digraph PositionSizing {
      rankdir=TB;
      bgcolor="#f9f9f9";
      fontname="Arial";
      fontsize=14;

      node [fontname="Arial", fontsize=11, style=filled];
      edge [fontname="Arial", fontsize=10];

      // Title
      title [label="Fuzzy Position Sizing Pipeline\n(7-Stage Calculation)",
             shape=box, fillcolor="#2c3e50", fontcolor=white, fontsize=16, style="filled,bold"];

      // Stage 0: Inputs
      subgraph cluster_inputs {
          label="Stage 0: Input Parameters";
          style=filled;
          fillcolor="#ecf0f1";

          input_equity [label="Total Equity\n($25,000)", shape=oval, fillcolor="#3498db", fontcolor=white];
          input_max_loss [label="Max Loss/Contract\n(width × 100)", shape=oval, fillcolor="#3498db", fontcolor=white];
          input_risk_pct [label="Risk Fraction\n(2%)", shape=oval, fillcolor="#3498db", fontcolor=white];
          input_memberships [label="9 Memberships\n{μ_mtf, μ_iv, μ_regime,\nμ_rsi, μ_adx, μ_stoch,\nμ_bb, μ_vol, μ_sma}", shape=oval, fillcolor="#3498db", fontcolor=white];
          input_weights [label="9 Weights\n{0.25, 0.18, 0.15,\n0.10, 0.10, 0.07,\n0.08, 0.04, 0.03}", shape=oval, fillcolor="#3498db", fontcolor=white];
          input_vix [label="VIX\n(realized vol)", shape=oval, fillcolor="#3498db", fontcolor=white];
      }

      // Stage 1: Hard Ceiling
      subgraph cluster_stage1 {
          label="Stage 1: Risk-Based Hard Ceiling";
          style=filled;
          fillcolor="#e8f5e9";

          calc_q0 [label="q₀ = floor((risk_pct × equity) / max_loss)\n\nExample:\nq₀ = floor((0.02 × $25,000) / $500)\nq₀ = floor($500 / $500)\nq₀ = 1 contract",
                   shape=box, fillcolor="#27ae60", fontcolor=white];

          output_q0 [label="q₀ = 1\n(Hard ceiling)", shape=oval, fillcolor="#2ecc71", fontcolor=white];

          calc_q0 -> output_q0;
      }

      // Stage 2: Fuzzy Confidence
      subgraph cluster_stage2 {
          label="Stage 2: Fuzzy Confidence Aggregation";
          style=filled;
          fillcolor="#fff3e0";

          calc_ft [label="Fuzzy Confidence (Ft):\n\nFt = Σ(wᵢ × μᵢ) for i=1 to 9\n\nFt = 0.25×μ_mtf + 0.18×μ_iv + 0.15×μ_regime +\n      0.10×μ_rsi + 0.10×μ_adx + 0.07×μ_stoch +\n      0.08×μ_bb + 0.04×μ_vol + 0.03×μ_sma\n\nExample (strong signal):\nFt = 0.25×0.8 + 0.18×0.9 + 0.15×0.7 + ... ≈ 0.78",
                  shape=box, fillcolor="#f39c12", fontcolor=white];

          output_ft [label="Ft = 0.78\n(78% confidence)", shape=oval, fillcolor="#f1c40f", fontcolor=white];

          calc_ft -> output_ft;
      }

      // Stage 3: Volatility Normalization
      subgraph cluster_stage3 {
          label="Stage 3: Volatility Normalization";
          style=filled;
          fillcolor="#e3f2fd";

          calc_sigma [label="Normalized Volatility (σ*):\n\nσ* = (VIX - low_vol) / (high_vol - low_vol)\nσ* = (VIX - 12) / (35 - 12)\n\nExample (VIX = 20):\nσ* = (20 - 12) / 23 ≈ 0.35",
                      shape=box, fillcolor="#2196f3", fontcolor=white];

          output_sigma [label="σ* = 0.35\n(35% of vol range)", shape=oval, fillcolor="#64b5f6", fontcolor=white];

          calc_sigma -> output_sigma;
      }

      // Stage 4: Scaling Factor
      subgraph cluster_stage4 {
          label="Stage 4: Scaling Factor Calculation";
          style=filled;
          fillcolor="#f3e5f5";

          calc_g [label="Scaling Factor (g):\n\ng = Ft × (1 - σ*)\ng = confidence × volatility_penalty\n\nExample:\ng = 0.78 × (1 - 0.35)\ng = 0.78 × 0.65\ng ≈ 0.51",
                  shape=box, fillcolor="#9c27b0", fontcolor=white];

          output_g [label="g = 0.51\n(51% scaling)", shape=oval, fillcolor="#ba68c8", fontcolor=white];

          calc_g -> output_g;
      }

      // Stage 5: Scaled Quantity
      subgraph cluster_stage5 {
          label="Stage 5: Apply Scaling to Ceiling";
          style=filled;
          fillcolor="#fce4ec";

          calc_q_scaled [label="Scaled Quantity:\n\nq_scaled = floor(q₀ × g)\n\nExample:\nq_scaled = floor(1 × 0.51)\nq_scaled = floor(0.51)\nq_scaled = 0 contracts",
                         shape=box, fillcolor="#e91e63", fontcolor=white];

          output_q_scaled [label="q_scaled = 0", shape=oval, fillcolor="#f06292", fontcolor=white];

          calc_q_scaled -> output_q_scaled;
      }

      // Stage 6: Minimum Guardrail
      subgraph cluster_stage6 {
          label="Stage 6: Minimum Quantity Guardrail";
          style=filled;
          fillcolor="#ede7f6";

          calc_min [label="Guardrail Logic:\n\nif q₀ ≥ 1:\n    q_final = max(1, q_scaled)\nelse:\n    q_final = 0\n\nExample:\nq_final = max(1, 0) = 1 contract\n(Prevents zero-position approval)",
                    shape=box, fillcolor="#673ab7", fontcolor=white];

          output_final [label="q_final = 1\n(Final quantity)", shape=oval, fillcolor="#9575cd", fontcolor=white];

          calc_min -> output_final;
      }

      // Flow connections
      title -> input_equity [style=invis];

      input_equity -> calc_q0;
      input_max_loss -> calc_q0;
      input_risk_pct -> calc_q0;

      output_q0 -> calc_ft [style=invis];

      input_memberships -> calc_ft;
      input_weights -> calc_ft;

      output_ft -> calc_sigma [style=invis];

      input_vix -> calc_sigma;

      output_sigma -> calc_g [style=invis];
      output_ft -> calc_g [style=dotted, label="Ft input"];
      output_sigma -> calc_g [style=dotted, label="σ* input"];

      output_g -> calc_q_scaled [style=invis];
      output_q0 -> calc_q_scaled [style=dotted, label="q₀ input"];
      output_g -> calc_q_scaled [style=dotted, label="g input"];

      output_q_scaled -> calc_min [style=invis];
      output_q0 -> calc_min [style=dotted, label="q₀ check"];
      output_q_scaled -> calc_min [style=dotted, label="q_scaled input"];

      // Summary
      summary [label="Pipeline Summary:\n\n1. Hard Ceiling (q₀): Risk-based upper limit\n2. Fuzzy Confidence (Ft): Weighted indicator aggregation\n3. Volatility Penalty (σ*): Normalize VIX to [0,1]\n4. Scaling Factor (g): Ft × (1 - σ*)\n5. Scaled Quantity: floor(q₀ × g)\n6. Guardrail: Ensure minimum 1 contract if q₀ ≥ 1\n\nResult: Conservative position sizing that\nscales down during low confidence or high volatility",
               shape=note, fillcolor="#ffffcc", fontsize=10];

      output_final -> summary [style=invis];
  }