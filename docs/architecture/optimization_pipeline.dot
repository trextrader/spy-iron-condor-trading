
digraph OptimizationPipeline {
    rankdir=LR;
    nodesep=0.6; 
    ranksep=0.7;
    splines=ortho;
    compound=true;
    node [shape=rect, style="filled,rounded", fontname="Helvetica", fontsize=11, margin="0.2,0.1"];
    edge [fontname="Helvetica", fontsize=9, color="#444444", arrowsize=0.8];

    # Title
    labelloc="t";
    label="Mamba 2 Neural Iron Condor System\nEnd-to-End Optimization Architecture";
    fontsize=18;

    # --- Data Sources ---
    subgraph cluster_data {
        label = "1. Data Acquisition";
        style="dashed,rounded";
        color="#888888";
        bgcolor="#F9F9F9";
        
        {rank=same; Alpaca; OptionsData}
        Alpaca [label="Alpaca Intraday\n(15-Min Bars)", fillcolor="#E3F2FD", color="#2196F3"];
        OptionsData [label="Option Feed\n(IVolatility)", fillcolor="#E3F2FD", color="#2196F3"];
    }

    # --- Training Pipeline ---
    subgraph cluster_training {
        label = "2. Neural Training (Offline)";
        style="filled,rounded";
        color="#E8EAF6";
        bgcolor="#E8EAF6";
        
        TrainScript [label="Train Harness\n(train_mamba.py)", shape=component, fillcolor="#FFCDD2", color="#D32F2F"];
        
        subgraph cluster_model {
            label = "DeepMamba 2 Network";
            style=filled;
            color="white";
            
            SSM [label="Mamba 2 Block Stack\n(32 Layers / 1024 Dim)\n[State Space Duality]", shape=octagon, fillcolor="#EF9A9A", color="#C62828"];
        }

        ModelWeights [label="Model Weights\n(mamba_active.pth)", shape=note, fillcolor="#FFF9C4", color="#FBC02D"];
        
        Alpaca -> TrainScript [label="Fetch History"];
        TrainScript -> SSM [label="Train (GPU)"];
        SSM -> ModelWeights [label="Save State"];
    }

    # --- Production Runtime ---
    subgraph cluster_runtime {
        label = "3. Production Optimizer (Runtime)";
        style="filled,rounded";
        color="#E8F5E9";
        bgcolor="#E8F5E9";
        
        Optimizer [label="Optimizer Engine\n(Segmented Grid Search)", shape=hexagon, fillcolor="#A5D6A7", color="#2E7D32", fontsize=12, penwidth=2];
        
        subgraph cluster_backtest {
            label = "Backtest Instance";
            style=filled;
            color="white";
            
            Inference [label="Inference Engine\n(Batch GPU Pre-Compute)", fillcolor="#FFCCBC", color="#D84315"];
            Strategy [label="Iron Condor Strategy\n(4-Leg Execution)", shape=folder, fillcolor="#C8E6C9", color="#2E7D32"];
            
            Inference -> Strategy [label="Regime Signal"];
        }

        Metrics [label="Profit / MaxDD\nReport", shape=ellipse, fillcolor="#EEEEEE"];
        
        Optimizer -> Strategy [label="Inject Params", style=dashed];
        Strategy -> Metrics [label="Result"];
        Metrics -> Optimizer [label="Feedback"];
    }

    # Inter-Cluster Edges
    ModelWeights -> Inference [label="Load Weights", lhead=cluster_backtest];
    OptionsData -> Strategy [label="Tick Data"];
    
}
